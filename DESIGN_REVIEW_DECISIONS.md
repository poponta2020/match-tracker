# 設計レビュー決定事項

**日付**: 2025-11-06
**レビュアー**: AI Assistant (Claude)
**承認者**: プロジェクトオーナー

---

## 1. データベース設計

### 1.1 player_profilesの履歴管理
**決定**: 現行の`valid_from`/`valid_to`による履歴管理を継続
- **理由**: 過去の対戦時点での選手の級・段位を正確に記録する必要がある
- **例**: D級の山田太郎との対戦記録を、太郎がC級に昇級後も保持

### 1.2 matchesテーブルの制約
**決定**: `player1_id < player2_id`の制約を追加
- **実装**: アプリケーション層で保証（CHECK制約は避ける）
- **目的**: データの一貫性確保、検索クエリの単純化

### 1.3 選手削除と論理削除
**決定**: 論理削除を実装
- `players`テーブルに`deleted_at TIMESTAMP NULL`を追加
- 削除権限は管理者のみ
- 対戦記録がある選手も論理削除可能

### 1.4 インデックスの追加
**決定**: 以下のインデックスを追加
```sql
-- matchesテーブル
CREATE INDEX idx_matches_date_player1 ON matches(match_date, player1_id);
CREATE INDEX idx_matches_date_player2 ON matches(match_date, player2_id);
CREATE INDEX idx_matches_winner ON matches(winner_id);

-- match_participationsテーブル
CREATE INDEX idx_participations_session_player ON match_participations(session_date, player_id);

-- player_profilesテーブル
CREATE INDEX idx_profiles_valid_to ON player_profiles(valid_to);
```

---

## 2. 認証・セキュリティ

### 2.1 認証方式
**決定**: ロールベースの権限管理に統一
- **識別子**: 選手名 + パスワード
- **ロール**: 3段階（後述）
- スーパー管理者と選手の認証基盤を統一

### 2.2 パスワードポリシー
**決定**: パスワードポリシーは設けない
- **理由**: ユーザー体験を優先。攻撃リスクが低いクローズドなアプリ
- 最小文字数などの制約なし

### 2.3 セッション管理
**決定**:
- **セッションタイムアウト**: 48時間
- **同時ログイン**: 許容
- **理由**: 制御による処理負荷増加を避ける

---

## 3. 機能要件

### 3.1 AI分析機能
**決定**: Anthropic Claude APIを使用
- **APIキー**: プロジェクトオーナーのClaude Pro Planのサブスクリプションは利用不可（API利用は別課金）
- **予算上限**: 月500円未満
- **レート制限**: 実装必要
  - **推奨設定**:
    - ユーザーあたり1日5回まで
    - または、全体で月100回まで（30名想定で1人3回/月程度）
    - Claude Sonnet 3.5使用で1回あたり約$0.01-0.02想定
    - 月100回で約$1-2（約150-300円）
- **エラーハンドリング**: レート制限超過時は明確なメッセージ表示

**補足**: Claude Pro Planは個人利用向けのサブスクリプションで、API利用とは別サービスです。API利用には従量課金のAPIキーが必要です。

### 3.2 対戦組み合わせ自動生成
**決定**:
- **級の近さ**: 考慮しない
- **待機者**: 以下の機能を実装
  1. 手動で事前に待機者を指定できる
  2. 自動で待機者を決定する機能も提供（奇数人数時）
  3. 待機者のローテーション機能は実装しない

### 3.3 権限管理（ロール定義）
**決定**: 3段階のロール制

| ロール | 権限 | 備考 |
|--------|------|------|
| **SUPER_ADMIN**<br>（最上位管理者） | - 選手の新規登録・削除<br>- 全選手の情報編集<br>- 管理者権限の付与・削除<br>- 練習日管理<br>- 対戦組み合わせ作成<br>- その他すべての機能 | 権限付与可能 |
| **ADMIN**<br>（管理者） | - 練習日管理<br>- 対戦組み合わせ作成<br>- 自分の選手情報編集<br>- 対戦結果入力・編集<br>- 個人成績閲覧<br>- 参加予定管理 | 権限付与・選手情報編集は不可 |
| **PLAYER**<br>（一般選手） | - 自分の選手情報編集<br>- 対戦結果入力・編集<br>- 個人成績閲覧<br>- 参加予定管理 | 基本機能のみ |

---

## 4. 画面設計

### 4.1 画面遷移の簡素化
**決定**: 結果入力周りを簡素化
- **変更内容**:
  - 判定画面（10. 結果入力画面）を廃止
  - トップページから直接「結果入力」と「結果確認」に分離
  - カレンダー選択を統一インターフェースに

**改善後の遷移**:
```
6. トップページ
   └── 8. 練習結果メニュー画面
       ├── 9. 参加予定入力画面
       ├── 11. 対戦結果入力画面（カレンダーから日付選択 → 入力）
       └── 12. カレンダー画面（結果確認専用）
           └── 13. 日付別試合一覧画面
               └── 14. 試合詳細画面
```

### 4.2 個人成績画面
**決定**: 現状維持
- 実装後の画面を見てから判断

### 4.3 エラー画面
**決定**: 最低限のエラー画面を実装
- **表示内容**:
  - エラーが発生した旨
  - HTTPステータスコード
  - 生のエラーメッセージ
  - スタックトレース（開発環境のみ）
- **目的**: 開発者が原因を特定できること

---

## 5. 非機能要件

### 5.1 パフォーマンス目標
**決定**: 応答時間目標3秒以内
- **用途**: 処理の重さを判断する基準
- 超過してもエラーにはしない

### 5.2 データ保持期間
**決定**: 対戦データは永久保持
- **想定データ量**: 週3回 × 4試合 × 20人 = 年間約12,000レコード
- データ量は問題にならない

### 5.3 バックアップ・リカバリ
**決定**: 初期段階では考慮しない

### 5.4 監視・ログ
**決定**:
- **監視**: 実装しない
- **ログ**:
  - アプリケーションログを保存
  - 保持期間: 30日程度（容量に応じて調整）
  - 永久保存はしない

---

## 6. 技術選定

### 6.1 Java バージョン
**決定**: Java 21 LTS（現在利用可能な最新LTS）
- Java 25は未リリースのため修正

### 6.2 デプロイ先
**決定**: AWS
- **予算**: 月500円以内
- **推奨構成**:
  - EC2 t3.micro または t4g.micro（無料枠利用可）
  - RDS db.t3.micro MySQL（無料枠利用可）
  - 無料枠終了後も月額$10-15程度（約1,500円）
  - **検討**: AWS LightsailやEC2 + 自前MySQL構築で月$5（約750円）も可能

**補足**: 月500円で完全に収めるのは難しいが、無料枠活用で最初の12ヶ月は無料運用可能

### 6.3 グラフライブラリ
**決定**: Chart.js（現行のまま）
- **理由**: 軽量でシンプル、要件に十分
- 他の高機能ライブラリは不要

---

## 7. 開発プロセス

### 7.1 段階的リリース計画

#### **Phase 1: MVP（Minimum Viable Product）**
**目標**: 基本的な対戦記録と成績表示

**含まれる機能**:
- 認証機能（ログイン・ログアウト）
- 選手管理（SUPER_ADMINのみ）
- 練習日管理
- 対戦結果入力（手動のみ）
- 個人成績表示（総合タブのみ、グラフなし）
- エラー画面

**除外する機能**:
- AI分析
- 対戦組み合わせ自動生成
- 参加予定管理
- 年別・月別タブ
- グラフ表示

---

#### **Phase 2: 成績分析機能強化**
**目標**: 成績の詳細分析とビジュアライゼーション

**追加機能**:
- 個人成績の年別・月別タブ
- 勝率推移グラフ（Chart.js）
- 級別成績テーブル
- 対戦相手別成績テーブル
- テーブルのソート機能
- 参加予定管理

---

#### **Phase 3: 自動化機能**
**目標**: 管理業務の効率化

**追加機能**:
- 対戦組み合わせ自動生成
- 待機者の手動・自動設定
- 事前組み合わせの表示（対戦結果入力時）

---

#### **Phase 4: AI分析機能**
**目標**: 高度な成績分析

**追加機能**:
- Anthropic Claude API連携
- 自然言語での質問機能
- レート制限の実装

---

### 7.2 テスト計画
**決定**: AI Assistantが実行

**テスト戦略**:
1. **単体テスト（Unit Test）**
   - JUnit 5使用
   - サービス層のビジネスロジックを重点的にテスト
   - カバレッジ目標: 70%以上

2. **結合テスト（Integration Test）**
   - Spring Boot Testで実装
   - データベース連携部分のテスト
   - @SpringBootTest使用

3. **E2Eテスト（End-to-End Test）**
   - 主要な画面遷移のテスト
   - 必要に応じて実装（Phase 1では最低限）

### 7.3 ユーザー受け入れテスト
**決定**: 考慮しない

---

## 8. その他

### 8.1 タイムゾーン
**決定**: 日本時間（JST）のみ対応

### 8.2 多言語対応
**決定**: 日本語のみ

### 8.3 アクセシビリティ
**決定**: 考慮しない

### 8.4 データエクスポート機能
**決定**: 実装しない（必要になれば後付け）

---

## データベーススキーマ変更サマリー

### playersテーブルへの追加
```sql
ALTER TABLE players ADD COLUMN deleted_at TIMESTAMP NULL;
ALTER TABLE players ADD COLUMN role ENUM('SUPER_ADMIN', 'ADMIN', 'PLAYER') NOT NULL DEFAULT 'PLAYER';
```

### is_adminカラムの廃止
```sql
ALTER TABLE players DROP COLUMN is_admin;
```

### super_adminsテーブルの廃止
- `super_admins`テーブルは削除
- SUPER_ADMINロールをplayersテーブルで管理

---

## 次のステップ

1. DESIGN_DOCUMENT.mdの更新
2. データベーススキーマの最終確定
3. Phase 1の詳細設計
4. 実装開始

---

**承認日**: 2025-11-06
**ステータス**: 承認済み
