# 作業履歴

このファイルには、プロジェクトの作業履歴を時系列で記録します。

## 2025-11-11 - 練習参加登録機能の実装と試合ごと参加人数表示機能

### 実装完了機能

1. **練習参加登録機能（月単位一括登録）**
   - 月別カレンダー形式で練習参加を登録
   - 各練習日の各試合にチェックボックスで参加登録
   - 試合ごとの参加人数をリアルタイム表示
   - 前月・次月への移動機能
   - 過去の練習日は編集不可（グレーアウト表示）

2. **試合ごとの参加人数表示機能**
   - チェックボックスの下にバッジで人数を表示
   - 定員に近いほど赤系の色で警告表示
     - 緑系（40%未満）: 余裕あり
     - 黄色系（40-59%）: やや余裕あり
     - オレンジ系（60-79%）: 注意
     - 赤系（80%以上）: 危険（満員に近い）
   - ホバー時にツールチップで「試合○に○名参加中」を表示
   - 過去の練習日は人数バッジを非表示（画面の視認性向上）

3. **練習登録時の仕様改善**
   - 参加者0人でも練習登録が可能に変更
   - バックエンド・フロントエンド両方のバリデーションを削除
   - 練習登録後に参加者を追加できる柔軟な運用に対応

4. **練習参加登録の保存処理改善**
   - 月単位での一括削除・登録方式を実装
   - 重複エントリエラーの解消
   - トランザクション処理の最適化（flush追加）

### 技術的詳細

**バックエンド修正**
- `PracticeSessionDto.java`
  - `matchParticipantCounts` フィールド追加（試合番号ごとの参加人数マップ）
- `PracticeSessionService.java`
  - `enrichSessionWithParticipants()`: 試合ごとの参加人数を集計
  - `enrichSessionsWithParticipants()`: リスト取得時も参加人数を集計
  - `findSessionsByYearMonth()`: enrichメソッドを呼ぶように修正
  - `registerParticipations()`: 月単位で既存データを削除してから登録
- `PracticeParticipantRepository.java`
  - `@Modifying`付きカスタム削除クエリ追加
  - `deleteByPlayerIdAndSessionIds()`: 複数セッションの参加記録を一括削除
- `PracticeParticipationRequest.java`
  - `year`, `month` フィールド追加（月単位削除のため）
- `PracticeSessionCreateRequest.java` / `PracticeSessionUpdateRequest.java`
  - 参加者リストの必須バリデーション削除
- データベース変更
  - `practice_participants.match_number` カラムを NULL許可に変更

**フロントエンド修正**
- `PracticeParticipation.jsx`
  - 月別カレンダー形式のUI実装
  - `getParticipantBadgeColor()`: 定員比率に応じた色分け関数
  - 試合ごとの参加人数バッジ表示
  - 過去の練習日は人数バッジを非表示
  - 参加予定列を削除（チェックボックス下の数字で十分なため）
  - 保存時に `year`, `month` を送信
- `PracticeForm.jsx`
  - 参加者2名以上のバリデーション削除
- `practices.js`
  - `getByYearMonth()`: 年月で練習セッション取得
  - `registerParticipations()`: 参加登録API
  - `getPlayerParticipations()`: 選手の参加状況取得

### データフロー

**練習参加登録フロー**
1. 練習参加登録画面を開く
2. 年月を選択（前月・次月ボタン）
3. 該当月の練習セッション一覧を取得（`getByYearMonth`）
4. 現在の選手の参加状況を取得（`getPlayerParticipations`）
5. 各試合にチェックを入れる
6. 保存ボタンクリック
7. バックエンドで該当月の既存データを削除
8. 新しいチェック状態を一括登録

**参加人数表示フロー**
1. 練習セッション取得時に `matchParticipantCounts` を計算
2. フロントエンドで各試合の参加人数を表示
3. 定員との比率で色分け表示

### 改善効果
- **柔軟な運用**: 参加者0人でも練習登録可能、後から参加者追加が容易
- **視認性向上**: 試合ごとの参加人数が一目で分かる
- **混雑度の把握**: 色分けで定員に近い試合が分かりやすい
- **データ整合性**: 月単位での一括削除・登録で重複エラーを解消
- **UI/UX改善**: 過去の練習日は人数を非表示にして画面をすっきり

### 動作確認済み
- バックエンド: http://localhost:8080 ✓
- フロントエンド: http://localhost:5173 ✓
- 練習参加登録: 月別カレンダー表示、保存機能 ✓
- 試合ごと参加人数表示: バッジ表示、色分け ✓
- 重複エントリエラー解消 ✓
- 0人での練習登録 ✓
- 全API呼び出し: 正常応答確認 ✓

### バグ修正
- 重複エントリエラー「Duplicate entry 'X-X-X' for key 'uk_session_player_match'」を解消
  - 原因: セッションごとの削除で、他のセッションの既存データが残っていた
  - 修正: 月単位で全セッションの参加データを削除してから登録
- 参加人数が常に0表示される問題を解消
  - 原因: `findSessionsByYearMonth()`が`enrichSessionsWithParticipants()`を呼んでいなかった
  - 修正: enrichメソッドを呼ぶように変更

## 2025-11-10 - 選手管理機能の強化と今日の対戦表示機能の実装

### 実装完了機能

1. **選手情報フィールドの追加と段級位システム実装**
   - 選手情報に以下のフィールドを追加:
     - 段位 (danRank): 無段、初段、弐段、参段、四段、五段、六段、七段、八段
     - 級位 (kyuRank): E級、D級、C級、B級、A級
     - 所属かるた会 (karutaClub)
     - 備考 (remarks)
   - 生年月日 (dateOfBirth) フィールドを削除

2. **自動段位設定機能**
   - 級位に応じて段位を自動設定:
     - E級 → 無段
     - D級 → 初段
     - C級 → 弐段
     - B級 → 参段
     - A級 → 四段～八段（選択可能）
   - A級選択時のみ段位フィールドが編集可能
   - 級位優先のフォーム設計

3. **当日参加者追加機能（組み合わせ生成画面）**
   - 事前登録なしの選手も組み合わせに追加可能
   - 「当日参加者を追加」ボタンをUI実装
   - 選手選択モーダルダイアログ
     - 全選手リストから選択
     - 級位・段位を表示
     - 既参加者は自動除外
   - 待機リストに自動追加される仕組み
   - 参加者0名でも機能利用可能

4. **今日の対戦表示機能（ホーム画面）**
   - ホーム画面に「今日の対戦」セクションを追加
   - 今日の日付の対戦組み合わせをAPI経由で取得
   - 対戦カード表示:
     - 選手1 vs 選手2
     - 試合番号
   - 統計カードに対戦数を表示
   - 「詳細を見る」リンクで組み合わせ画面へ遷移

5. **UI/UX改善**
   - 組み合わせ生成画面の日本語化完了
   - エラーメッセージの日本語化
   - 選手追加モーダルのバリデーション強化

### 技術的詳細

**バックエンド修正**
- `Player.java`
  - DanRank enum追加（9種類）
  - KyuRank enum追加（5種類）
  - フィールド追加: danRank, kyuRank, karutaClub, remarks
  - フィールド削除: dateOfBirth
- `PlayerDto.java`
  - 同様のフィールド変更を反映
- `PlayerCreateRequest.java` / `PlayerUpdateRequest.java`
  - リクエストDTOにrank関連フィールドを追加
  - dateOfBirth関連コードを削除

**フロントエンド修正**
- `PlayerEdit.jsx`
  - handleKyuRankChange()関数で自動段位設定
  - 級位→段位の順にフォーム配置変更
  - A級以外は段位フィールドを無効化
  - dateOfBirth入力フィールド削除
- `PlayerDetail.jsx`
  - getRankDisplay()で段位・級位を表示
  - dateOfBirth表示削除
- `PlayerList.jsx`
  - 一覧に段位・級位、所属かるた会を表示

- `PairingGenerator.jsx`
  - playerAPI.getAll()で全選手取得
  - handleAddPlayer()で当日参加者を追加
  - availablePlayersフィルタで重複除外
  - 選手追加モーダルUI実装
  - 全エラーメッセージを日本語化
  - 見出し・ボタンを日本語化

- `Home.jsx`
  - pairingAPI.getByDate()で今日の対戦を取得
  - todayPairingsセクション実装
  - 対戦カード表示UI実装

- `pairings.js`
  - getByDate() APIエンドポイント確認（既存）

### データフロー

**選手登録フロー**
1. 級位を選択 → 自動的に段位が設定される
2. A級の場合のみ四段～八段から選択可能
3. 所属かるた会、備考を入力
4. 登録 → Player entity保存

**当日参加者追加フロー**
1. 組み合わせ生成画面で「当日参加者を追加」をクリック
2. モーダルで選手を選択（級位・段位表示）
3. 追加 → 待機リストに追加
4. 参加者リストにも追加
5. 自動組み合わせ、または手動組み合わせに使用可能

**今日の対戦表示フロー**
1. ホーム画面読み込み時
2. 今日の日付をISO形式で取得
3. pairingAPI.getByDate(todayStr)呼び出し
4. 取得した組み合わせを表示
5. 組み合わせがない場合はセクション非表示

### 改善効果
- **段級位管理の正確性向上**: 競技かるたの段級位システムに完全対応
- **運用の柔軟性向上**: 事前登録なしの当日参加者も簡単に追加可能
- **視認性向上**: ホーム画面で今日の対戦が一目で確認可能
- **ユーザビリティ向上**: 自動段位設定で入力ミス削減

### 動作確認済み
- バックエンド: http://localhost:8080 ✓
- フロントエンド: http://localhost:5173 ✓
- 選手登録機能: 段級位の自動設定が正常動作 ✓
- 当日参加者追加: 待機リストへの追加が正常動作 ✓
- 今日の対戦表示: ホーム画面に正常表示 ✓
- 全API呼び出し: 正常応答確認 ✓

### バグ修正
- 選手登録時のUTF-8エンコーディング問題を調査
  - curlコマンドのWindows PowerShell制限と判明
  - フロントエンドからの登録は正常動作を確認
- dateOfBieldフィールド削除による互換性問題なし

## 2025-11-09 - 試合記録機能の実装とUI改善

### 実装完了機能
1. **練習記録機能（完全実装）**
   - 練習セッション一覧・登録・編集・削除機能
   - 練習参加者管理機能
   - 練習日別の参加者一覧表示
   - ホーム画面に「次の練習」セクション追加（未来の練習のみ表示）

2. **試合記録機能の強化**
   - 練習日に基づく対戦相手選択機能
     - 試合日を選択すると、その日の練習参加者を自動表示
     - 練習日未設定の場合は全選手から選択可能
     - 検索機能付き選手リスト
   - 練習参加者インジケーター表示
     - 練習日の場合：青色の情報バナー
     - 練習日未設定の場合：黄色の警告バナー

3. **試合記録登録画面のUI/UX改善**
   - **日付入力の改善**
     - 今日の日付を選択時は「今日」と表示（ハイライトなし、普通の黒字）
     - 日付の実際の値は非表示にして、「今日」テキストをオーバーレイ表示
   - **用語の変更**
     - 「札差」→「枚数差」に統一
     - ヘルプテキストを削除（シンプル化）
   - **エラーメッセージの配置改善**
     - 画面上部から登録ボタン直前に移動
     - スマホ画面でもエラーが見やすく改善

4. **重複登録防止機能**
   - バックエンド：同日・同試合番号の重複登録チェック実装
   - リポジトリに`existsByPlayerIdAndMatchDateAndMatchNumber`クエリ追加
   - エラーメッセージ：「この日の第X試合は既に登録されています」
   - デバッグログ追加で検証可能に

5. **入力値の改善**
   - 枚数差：正の数のみ入力可能（`min="0"`）
   - 勝敗に関わらず正の数で統一

### 技術的詳細

**バックエンド修正**
- `MatchRepository.java`
  - 重複チェッククエリ追加（行129-132）
- `MatchService.java`
  - `createMatchSimple`に重複チェックロジック追加（行122-133）
  - デバッグログ追加で検証可能に
- `GlobalExceptionHandler.java`
  - `IllegalArgumentException`を400 Bad Requestで返却（既存機能）

**フロントエンド修正**
- `MatchForm.jsx`
  - 練習セッション取得useEffect追加（行58-85）
  - 日付表示の条件付きレンダリング（行125-131）
  - エラーメッセージ配置変更（行241-247）
  - 用語変更：枚数差（行187-202）
- `practices.js`
  - `getByDate`、`getParticipants`エンドポイント追加
- `Home.jsx`
  - 「次の練習」セクション実装（未来日付のフィルタリング）

### データフロー
1. 試合日選択 → 練習セッション取得API呼び出し
2. 練習セッションが存在 → 参加者一覧取得
3. 対戦相手選択リストに練習参加者を表示
4. 試合登録時に重複チェック実行

### 改善効果
- **ユーザビリティ向上**：練習参加者から簡単に対戦相手を選択可能
- **入力ミス削減**：重複登録の防止、練習日未設定時の警告表示
- **モバイル対応強化**：エラーメッセージが視認しやすい位置に表示

### 動作確認済み
- バックエンド：http://localhost:8080
- フロントエンド：http://localhost:5173
- 重複登録防止機能：正常動作
- 練習参加者選択：正常動作
- エラー表示：ボタン直前に表示

## 2025-11-06 - カレンダー画面の改善

### 画面設計の変更
- **カレンダー画面（画面7）の機能強化**
  - 日付選択時に同画面内でタブ表示を追加
  - タブ構成: [第1試合目] [第2試合目] [第3試合目] ... （その日の試合数に応じて動的生成）
  - 各タブに試合結果を表示（対戦カード、勝者、枚数差、コメント）
  - 「この日の結果を入力」ボタンを同画面内に配置

- **日付別試合一覧画面（旧画面8）を廃止**
  - カレンダー画面に機能を統合し、UX向上
  - 画面遷移を簡素化（カレンダー→日付一覧→詳細 を カレンダー→詳細 に短縮）

### 画面数の変更
- 16画面 → 15画面（日付別試合一覧画面の廃止により削減）

### ドキュメント更新
- `DESIGN_DOCUMENT.md`を更新
  - 画面遷移図の修正（画面7の動作変更、画面8-15の番号変更）
  - 画面詳細仕様の追加（画面7のタブ表示レイアウト例を追加）
  - 送信後の遷移先を更新（対戦結果入力、試合詳細からカレンダー画面へ）

## 2025-11-06 - 設計レビューと改善実施

### 設計レビュー
- DESIGN_DOCUMENT.mdの包括的レビュー実施
- プロのアプリケーション作成者の観点から修正点・改善点を抽出
- ユーザーとの詳細な要件確認と決定事項の記録

### 主要な設計変更
1. **技術スタック更新**
   - Java: 25.0.1 → 21 LTS（現在利用可能な最新LTS）
   - デプロイ先: Railway/Render → AWS（EC2 + RDS または Lightsail）
   - 外部API追加: Anthropic Claude API（AI分析機能）

2. **認証・権限管理の統一**
   - スーパー管理者と選手の認証を統一（選手名 + パスワード）
   - 3段階のロールベース権限管理を実装
     - SUPER_ADMIN（最上位管理者）: 全機能
     - ADMIN（管理者）: 練習日管理、組み合わせ作成、基本機能
     - PLAYER（一般選手）: 基本機能のみ
   - セッションタイムアウト: 48時間
   - パスワードポリシー: なし（ユーザー体験優先）

3. **データベース設計の改善**
   - `super_admins`テーブルを廃止
   - `players`テーブルに追加:
     - `role` ENUM('SUPER_ADMIN', 'ADMIN', 'PLAYER')
     - `deleted_at` TIMESTAMP（論理削除対応）
   - 新規テーブル追加: `ai_usage_logs`（AI分析使用記録）
   - インデックスの最適化
     - players: idx_name_active, idx_deleted_at
     - player_profiles: idx_valid_to
     - matches: idx_matches_date, idx_matches_date_player1/2, idx_matches_winner
     - practice_sessions: idx_session_date
     - match_participations: idx_participations_session_player
   - テーブル数: 7テーブル（構成変更）

4. **画面設計の簡素化**
   - 判定画面（10. 結果入力画面）を廃止
   - 認証画面を統一（ロール別にメニュー表示を変更）
   - 画面数: 17画面 → 16画面
   - エラー画面を追加（HTTPステータスコード、エラーメッセージ、スタックトレース表示）

5. **AI分析機能の詳細化**
   - Anthropic Claude API使用
   - レート制限: アプリ全体で月100回まで
   - 毎月1日0時にカウンターリセット
   - 月次使用回数のみ記録（個別リクエスト履歴は保存しない）

6. **待機者機能の追加**
   - 対戦組み合わせ作成時に待機者を手動/自動で設定可能
   - 奇数人数時の自動待機者決定機能
   - ローテーション機能は実装しない

### 非機能要件の明確化
- **パフォーマンス**: 応答時間目標3秒以内（基準値、超過してもエラーにしない）
- **ログ管理**: SLF4J + Logback、保持期間30日
- **データ保持**: 対戦データ永久保持、バックアップは初期段階では考慮しない
- **タイムゾーン**: 日本時間（JST）のみ
- **多言語対応**: なし
- **アクセシビリティ**: 考慮しない

### 段階的リリース計画の策定
**Phase 1: MVP（Minimum Viable Product）**
- 認証、選手管理、練習日管理、対戦結果入力、基本成績表示
- データベース: players, player_profiles, matches, practice_sessions

**Phase 2: 成績分析機能強化**
- 年別・月別タブ、グラフ表示、級別・対戦相手別成績テーブル
- 参加予定管理
- データベース: match_participations追加

**Phase 3: 自動化機能**
- 対戦組み合わせ自動生成、待機者設定
- 事前組み合わせ表示
- データベース: match_pairings追加

**Phase 4: AI分析機能**
- Claude API連携、レート制限実装
- データベース: ai_usage_logs追加

### ドキュメント更新
- `DESIGN_DOCUMENT.md`を全面改訂
  - 最終更新日: 2025-11-06
  - レビュー実施日: 2025-11-06
  - 段階的リリース計画を追加
- `DESIGN_REVIEW_DECISIONS.md`を新規作成
  - 設計レビューの決定事項を詳細に記録
  - データベーススキーマ変更サマリー
  - 次のステップの明記

### その他の決定事項
- AWS料金: 無料枠利用で12ヶ月無料、以降月$10-15程度（月500円以内は困難）
- AI API予算: 月$3程度（約450円）、月100回制限
- データ量見積: 週3回×4試合×20人 = 年間約12,000レコード
- 画面遷移の可視化と整理（ユーザーからの質問対応）

### 次のステップ
- Phase 1（MVP）の詳細設計
- 実装開始準備

## 2025-11-05 - アプリケーション設計の完了

### 要件定義・設計
- プロジェクト要件の整理と確認
  - 競技かるた練習結果管理アプリの基本コンセプト確定
  - 4つの主要画面構成を決定（対戦結果入力、日付別一覧、対戦詳細、個人成績）
  - 技術スタック決定：Spring Boot + Thymeleaf + MySQL

### データベース設計
- 7テーブルの設計完了
  1. players（選手マスタ）
  2. player_profiles（選手情報履歴）- 級・段位の変更履歴管理
  3. matches（対戦結果）- 作成者・更新者の記録
  4. super_admins（スーパー管理者）
  5. practice_sessions（練習日情報）
  6. match_participations（選手の参加予定）
  7. match_pairings（対戦組み合わせ）★新規追加
- ER図の作成
- インデックス設計とパフォーマンス最適化の検討

### 画面設計
- 17画面の詳細設計完了
  - スーパー管理者用：4画面
  - 一般ユーザー用：13画面
- 画面遷移図の作成
- UI/UX仕様の決定
  - レスポンシブデザイン（スマホ対応）
  - Select2による検索可能なセレクトボックス
  - Chart.jsによる勝率推移グラフ

### 個人成績機能の詳細設計
- 総合/年別/月別のタブ切り替え機能
- 基本成績、級別成績、対戦相手別成績の表示
- ソート機能付きテーブル
- 勝率推移グラフ（年別・月別）
- AI分析機能（自然言語での質問対応）

### 対戦組み合わせ自動生成機能の設計★新規
- 自動マッチングアルゴリズムの設計
  - 対戦履歴を考慮（過去30日間、直近ほど重視）
  - 同日の別試合で既に対戦した相手は除外
  - パフォーマンス最適化（2回のDBクエリのみ、推定応答時間50-100ms）
- 手動調整機能（セレクトボックスで入れ替え・追加・削除）
- 組み合わせの保存と対戦結果入力時の参照機能

### ドキュメント作成
- `DESIGN_DOCUMENT.md`の作成
  - プロジェクト概要
  - 技術スタック
  - 機能要件（8項目）
  - 画面一覧と遷移図
  - データベース設計（7テーブル詳細）
  - 画面詳細仕様
  - パフォーマンス・セキュリティに関する補足事項

### その他
- `.gitignore`の文字化け修正
- `paper.txt`で要件の整理

## 2025-10-30 08:04 - プロジェクト初期セットアップ

- Gitリポジトリを初期化
- `.gitignore`ファイルを作成（node_modules、venv、ビルド成果物、環境変数、IDE設定などを除外）
- `README.md`ファイルを作成（プロジェクトの説明、機能、セットアップ手順のテンプレート）
- GitHubリポジトリ（match-tracker）と接続
- ローカルとリモートのマージコンフリクトを解決（`.gitignore`ファイル）
- 初回コミットをGitHubにプッシュ完了
- 作業履歴ファイル（`CHANGELOG.md`）を作成
