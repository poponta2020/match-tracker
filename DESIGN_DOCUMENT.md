# 競技かるた練習結果管理アプリ 設計書

**最終更新日**: 2025-11-06
**レビュー実施日**: 2025-11-06
**変更履歴**: DESIGN_REVIEW_DECISIONS.md参照

---

## 目次

1. [プロジェクト概要](#プロジェクト概要)
2. [技術スタック](#技術スタック)
3. [機能要件](#機能要件)
4. [画面一覧と遷移図](#画面一覧と遷移図)
5. [データベース設計](#データベース設計)
6. [画面詳細仕様](#画面詳細仕様)

---

## プロジェクト概要

### 目的
競技かるたの練習における対戦結果を記録・管理し、個人の成績を可視化・分析するWebアプリケーション

### 対象ユーザー
- かるたサークル・かるた会の選手（30名程度を想定）
- 管理者（スーパー管理者、管理者権限を持つ選手）

### 主要機能
1. 対戦結果の入力・閲覧
2. 個人成績の表示（総合/年別/月別）
3. 級別成績、対戦相手別成績の分析
4. 勝率推移グラフの表示
5. AI による成績分析
6. 参加予定の管理
7. 対戦組み合わせの自動生成（管理者機能）
8. 選手・練習日の管理（管理者機能）

---

## 技術スタック

### フロントエンド
- HTML5
- CSS3
- JavaScript
- Thymeleaf（テンプレートエンジン）
- Chart.js（グラフ描画）
- Select2（検索可能なセレクトボックス）
- Bootstrap（レスポンシブデザイン）

### バックエンド
- Java 21 LTS
- Spring Boot 3.4.1
- Spring Data JPA
- Spring Security（認証・認可）
- Gradle 9.2.0

### データベース
- MySQL 8.0+

### 外部API
- Anthropic Claude API（AI分析機能）

### デプロイ
- AWS（EC2 + RDS または Lightsail）
- 予算目安: 無料枠利用で12ヶ月無料、以降月$10-15程度

---

## 機能要件

### 1. ユーザー管理（ロールベース権限管理）

#### ロール定義

| ロール | 権限 |
|--------|------|
| **SUPER_ADMIN**<br>（最上位管理者） | - 選手の新規登録・削除（論理削除）<br>- 全選手の情報編集<br>- 管理者権限の付与・削除<br>- 練習日管理<br>- 対戦組み合わせ作成<br>- その他すべての機能 |
| **ADMIN**<br>（管理者） | - 練習日管理<br>- 対戦組み合わせ作成<br>- 自分の選手情報編集<br>- 対戦結果入力・編集<br>- 個人成績閲覧<br>- 参加予定管理 |
| **PLAYER**<br>（一般選手） | - 自分の選手情報編集<br>- 対戦結果入力・編集<br>- 個人成績閲覧<br>- 参加予定管理 |

**注意事項**:
- ADMINは他の選手の情報編集や権限付与はできない
- 選手の削除は論理削除（`deleted_at`に削除日時を記録）
- 削除された選手は一覧に表示されないが、過去の対戦記録は保持される

### 2. 認証機能
- **認証方式**: 選手名 + パスワード（全ユーザー共通）
- **セッション管理**:
  - セッションタイムアウト: 48時間
  - 同時ログイン: 許容
- **パスワードポリシー**: なし（ユーザー体験を優先）
- **パスワード保存**: BCryptでハッシュ化

### 3. 対戦結果管理
- **入力項目**
  - 対戦日（デフォルト: 今日）
  - 試合番号（第何試合目か: 1～練習日設定の試合数）
  - 対戦相手（五十音順、検索可能）
  - 勝敗（デフォルト: 勝ち）
  - 枚数差（1～50）
  - コメント（任意）

- **制約**
  - 練習日が設定されていない日は入力不可
  - 自分が関わった試合のみ編集・削除可能
  - 作成者・最終更新者・更新日時を記録

### 4. 個人成績表示
- **表示期間**: 総合/年別/月別（タブ切り替え）
- **表示内容**（各期間共通）
  1. 基本成績
     - 総対戦数、勝利数、敗北数、勝率
     - 勝利時平均枚数差、敗北時平均枚数差
  2. 級別成績（対戦相手の級ごとの成績）
     - テーブル形式、ソート可能
  3. 勝率推移グラフ
     - 総合: 年別推移
     - 年別: 月別推移
     - 月別: なし
  4. 対戦相手別成績
     - テーブル形式、ソート可能
  5. AI 分析（Phase 4で実装）
     - Anthropic Claude APIを使用
     - 自然言語で質問可能
     - 選択中の期間のデータを基に分析
     - 結果は保存せず、最新の1件のみ表示
     - **レート制限**: アプリ全体で月100回まで
       - 月100回を超えた場合はエラーメッセージを表示
       - 毎月1日0時にカウンターをリセット

### 5. 参加予定管理
- 複数の日付・試合番号を一度に登録可能
- カレンダー形式で日付選択 → 試合番号をチェックボックスで選択
- 登録済み予定の表示・削除（訂正可能）

### 6. 結果確認
- カレンダー形式で日付を選択
- 練習日のみ活性化、対戦結果がある日を強調表示
- 前後の月に移動可能
- 日付別試合一覧から試合詳細へ遷移

### 7. 管理者機能
- **選手管理（SUPER_ADMINのみ）**
  - 選手の新規登録（名前、パスワード、性別、利き手、級、段位、所属かるた会、ロール）
  - 選手情報編集（全選手の情報を編集可能）
  - 選手削除（論理削除: `deleted_at`に削除日時を記録）
  - 管理者権限の付与/削除（ロールの変更）

- **練習日管理（SUPER_ADMINとADMIN）**
  - 練習日の新規作成（日付 + 予定試合数）
  - 練習日の編集
  - 練習日の削除

### 8. 対戦組み合わせ自動生成（SUPER_ADMINとADMIN）
- **待機者設定機能**
  - 手動で事前に待機者を指定可能
  - 自動で待機者を決定する機能も提供（奇数人数時）
  - 待機者のローテーション機能は実装しない

- **自動マッチング機能**
  - 参加予定者（待機者を除く）から最適な対戦ペアを自動生成
  - 対戦履歴を考慮（過去30日間、直近ほど重視）
  - 同日の別試合で既に対戦した相手は除外
  - 級の近さは考慮しない

- **手動調整機能**
  - セレクトボックスで選手を入れ替え
  - ペアの追加・削除
  - 対戦履歴の表示（参考情報）

- **組み合わせの保存**
  - 確定した組み合わせをDBに保存
  - 対戦結果入力時に参照可能（推奨として表示）
  - 手動で別の相手を選ぶことも可能

- **制約**
  - 既に組み合わせが保存されている場合は削除してから再作成
  - SUPER_ADMINまたはADMINのみが使用可能
  - 1試合ずつマッチングを作成

---

## 画面一覧と遷移図

**注**: スーパー管理者と選手の認証は統一され、ロールベースで権限管理を行う

### 全ユーザー共通
```
1. ログイン画面（選手名 + パスワード）
   └── 2. トップページ（ロールに応じてメニューが変化）
       ├── 3. 個人成績画面
       │   ├── 総合タブ
       │   ├── 年別タブ（年選択プルダウン）
       │   ├── 月別タブ（年月選択プルダウン）
       │   └── AI分析エリア（Phase 4）
       │
       ├── 4. 練習結果メニュー画面
       │   ├── 5. 参加予定入力画面
       │   │   └── カレンダー + チェックボックス
       │   │
       │   ├── 6. 対戦結果入力画面
       │   │   ├── カレンダーから日付選択
       │   │   ├── 日付、試合番号、対戦相手、勝敗、枚数差、コメント
       │   │   └── [送信] → 7. 日付別試合一覧画面
       │   │
       │   └── 7. カレンダー画面（結果確認専用）
       │       └── [日付選択] → 8. 日付別試合一覧画面
       │           ├── 「この日の試合結果を入力」ボタン → 6
       │           └── [試合選択] → 9. 試合詳細画面
       │               ├── 対戦カード、勝者、枚数差、コメント
       │               ├── 作成者、最終更新者、更新日時
       │               ├── 編集ボタン（自分が関わった試合のみ）
       │               └── 削除ボタン（自分が関わった試合のみ）
       │
       ├── 10. マイページ画面
       │   └── 選手情報編集（級、段位、所属かるた会、性別、利き手、パスワード）
       │
       ├── 11. 管理者メニュー（ADMINとSUPER_ADMINのみ表示）
       │   ├── 12. 練習日管理画面
       │   │   ├── 練習日一覧
       │   │   ├── 練習日新規作成
       │   │   ├── 練習日編集
       │   │   └── 練習日削除
       │   │
       │   └── 13. 対戦組み合わせ作成画面
       │       ├── 対戦日・試合番号選択
       │       ├── 待機者の手動/自動設定
       │       ├── 自動マッチング実行
       │       ├── 手動調整（セレクトボックスで入れ替え・削除・追加）
       │       └── 確定して保存 → match_pairings テーブルに保存
       │
       ├── 14. スーパー管理者メニュー（SUPER_ADMINのみ表示）
       │   └── 15. 選手管理画面
       │       ├── 選手一覧
       │       ├── 選手新規登録
       │       ├── 選手編集（全選手）
       │       ├── 選手削除（論理削除）
       │       └── ロール変更（権限の付与/削除）
       │
       └── 16. エラー画面
           ├── エラーメッセージ
           ├── HTTPステータスコード
           └── スタックトレース（開発環境のみ）
```

**画面数**: 16画面（判定画面を廃止し、認証を統一したため削減）

---

## データベース設計

### ER図（概念）
```
Players ──┬── Player_Profiles (1:N, 履歴管理)
          │
          ├── Match_Participations (1:N)
          │
          ├── Matches (N:M, player1/player2/winner/created_by/updated_by)
          │
          ├── Match_Pairings (N:M, player1/player2/created_by)
          │
          └── AI_Usage_Logs (1:N, AI分析の使用記録)

Practice_Sessions ──┬── Match_Participations (1:N)
                    │
                    └── Match_Pairings (1:N)
```

**注**: `super_admins`テーブルは廃止。ロール管理を`players`テーブルに統合。

### テーブル定義

#### 1. players（選手マスタ）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 選手ID |
| name | VARCHAR(100) | NOT NULL, UNIQUE | 選手名（ログインにも使用） |
| password | VARCHAR(255) | NOT NULL | パスワード（BCryptでハッシュ化） |
| gender | ENUM('男性', '女性', 'その他') | NOT NULL | 性別 |
| dominant_hand | ENUM('右', '左', '両') | NOT NULL | 利き手 |
| role | ENUM('SUPER_ADMIN', 'ADMIN', 'PLAYER') | NOT NULL, DEFAULT 'PLAYER' | ロール |
| deleted_at | TIMESTAMP | NULL | 削除日時（論理削除） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_name_active` (name, deleted_at) - ログイン時のクエリ最適化
- `idx_deleted_at` (deleted_at) - 削除済み選手の除外クエリ最適化

**注意事項**:
- `deleted_at`がNULLの場合はアクティブな選手
- 論理削除された選手も過去の対戦記録は保持される
- `is_admin`フラグは廃止し、`role`で権限管理

#### 2. player_profiles（選手情報履歴）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | プロフィールID |
| player_id | BIGINT | FK → players.id, NOT NULL, ON DELETE CASCADE | 選手ID |
| karuta_club | VARCHAR(200) | NOT NULL | 所属かるた会 |
| grade | ENUM('A', 'B', 'C', 'D', 'E') | NOT NULL | 級 |
| dan | ENUM('無', '初', '二', '三', '四', '五', '六', '七', '八') | NOT NULL | 段位 |
| valid_from | DATE | NOT NULL | 有効開始日 |
| valid_to | DATE | NULL | 有効終了日（NULLなら現在有効） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_player_date` (player_id, valid_from, valid_to)
- `idx_valid_to` (valid_to) - 現在有効なプロフィール検索の最適化

**運用ルール**:
- 現在有効なプロフィールは `valid_to = NULL`
- 選手情報更新時、既存レコードの `valid_to` に更新日を設定し、新レコードを追加
- 対戦時の相手の級・段位は、対戦日時点で有効だったプロフィールから取得

#### 3. matches（対戦結果）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 対戦ID |
| match_date | DATE | NOT NULL | 対戦日 |
| match_number | INT | NOT NULL | その日の第何試合目か |
| player1_id | BIGINT | FK → players.id, NOT NULL, ON DELETE RESTRICT | 選手1 |
| player2_id | BIGINT | FK → players.id, NOT NULL, ON DELETE RESTRICT | 選手2 |
| winner_id | BIGINT | FK → players.id, NOT NULL, ON DELETE RESTRICT | 勝者 |
| score_difference | INT | NOT NULL, CHECK(1 <= score_difference <= 50) | 枚数差 |
| notes | TEXT | NULL | コメント |
| created_by | BIGINT | FK → players.id, NOT NULL | 作成者 |
| updated_by | BIGINT | FK → players.id, NOT NULL | 最終更新者 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**制約**:
- `score_difference`: 1～50の範囲
- 対戦記録がある選手も論理削除可能（ON DELETE RESTRICTは物理削除を防ぐため）
- アプリケーション層で `player1_id < player2_id` を保証（データの一貫性）

**インデックス**:
- `idx_matches_date` (match_date) - 日付別試合一覧の最適化
- `idx_matches_date_player1` (match_date, player1_id)
- `idx_matches_date_player2` (match_date, player2_id)
- `idx_matches_winner` (winner_id)
- `idx_matches_date_match_number` (match_date, match_number)

#### 4. practice_sessions（練習日情報）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 練習日ID |
| session_date | DATE | NOT NULL, UNIQUE | 練習日 |
| total_matches | INT | NOT NULL | その日の予定試合数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_session_date` (session_date) - 練習日検索の最適化

#### 5. match_participations（選手の参加予定）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 参加予定ID |
| player_id | BIGINT | FK → players.id, NOT NULL, ON DELETE CASCADE | 選手ID |
| session_date | DATE | NOT NULL | 参加予定日 |
| match_number | INT | NOT NULL | 参加予定試合番号 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |

**ユニークキー**:
- `unique_participation` (player_id, session_date, match_number)

**インデックス**:
- `idx_participations_session_player` (session_date, player_id)

#### 6. match_pairings（対戦組み合わせ）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | 組み合わせID |
| session_date | DATE | NOT NULL | 対戦日 |
| match_number | INT | NOT NULL | その日の第何試合目か |
| player1_id | BIGINT | FK → players.id, NOT NULL, ON DELETE RESTRICT | 選手1 |
| player2_id | BIGINT | FK → players.id, NOT NULL, ON DELETE RESTRICT | 選手2 |
| created_by | BIGINT | FK → players.id, NOT NULL | 作成者（管理者） |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**インデックス**:
- `idx_session_match` (session_date, match_number)
- `idx_players` (player1_id, player2_id)

**制約**:
- 同じ試合に同じ選手は1回のみ登場可能（アプリケーション層でバリデーション）
- 対戦結果が入力されても組み合わせは残る（記録として保持）

**運用ルール**:
- SUPER_ADMINまたはADMINが対戦組み合わせ作成画面で作成
- 選手は対戦結果入力時に参照可能（推奨として表示）
- 既存の組み合わせがある場合、削除してから再作成

#### 7. ai_usage_logs（AI分析使用記録）
| カラム名 | データ型 | 制約 | 説明 |
|---------|---------|------|------|
| id | BIGINT | PK, AUTO_INCREMENT | ログID |
| player_id | BIGINT | FK → players.id, NOT NULL, ON DELETE CASCADE | 使用した選手ID |
| usage_month | VARCHAR(7) | NOT NULL | 使用月（YYYY-MM形式） |
| request_count | INT | NOT NULL, DEFAULT 0 | その月の使用回数 |
| created_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | 作成日時 |
| updated_at | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP | 更新日時 |

**ユニークキー**:
- `unique_player_month` (player_id, usage_month)

**インデックス**:
- `idx_usage_month` (usage_month) - 月次集計の最適化

**運用ルール**:
- AI分析リクエストごとに該当月のレコードを更新（UPSERT）
- 月初にアプリ全体の使用回数を集計し、100回を超えていないか確認
- 超過している場合はエラーメッセージを表示

**注**: 個別のリクエスト履歴は保存せず、月次の使用回数のみ記録（コスト削減のため）

---

## 画面詳細仕様

### 7. 個人成績画面

#### レイアウト
```
期間選択タブ: [総合] [年別] [月別]

-----------------------------------------------------------

■ 総合タブ / 年別タブ / 月別タブ（共通構成）

  【基本成績】
  総対戦数: X試合
  勝利数: Y勝  敗北数: Z敗
  勝率: W%
  勝利時平均枚数差: A枚
  敗北時平均枚数差: B枚

  【級別成績】
  対戦相手の級 ↑↓ | 対戦数 ↑↓ | 勝 ↑↓ | 敗 ↑↓ | 勝率 ↑↓
  -------------------|-----------|--------|--------|----------
  A級                | ...       | ...    | ...    | ...
  B級                | ...       | ...    | ...    | ...
  C級                | ...       | ...    | ...    | ...
  D級                | ...       | ...    | ...    | ...
  E級                | ...       | ...    | ...    | ...

  【勝率推移グラフ】
  ※総合タブ: 年別勝率の折れ線グラフ
  ※年別タブ: 月別勝率の折れ線グラフ
  ※月別タブ: なし

  【対戦相手別成績】
  対戦相手 ↑↓ | 対戦数 ↑↓ | 勝 ↑↓ | 敗 ↑↓ | 勝率 ↑↓
  -------------|-----------|--------|--------|----------
  山田太郎      | ...       | ...    | ...    | ...
  佐藤花子      | ...       | ...    | ...    | ...

  【AI分析】
  ┌────────────────────────────────────┐
  │ 質問を入力してください:                     │
  │ ┌──────────────────────────────┐   │
  │ │ 例: 最近の調子はどうですか？         │   │
  │ │     A級との対戦で改善すべき点は？   │   │
  │ └──────────────────────────────┘   │
  │ [分析を実行] ボタン                        │
  │                                           │
  │ --- 分析結果 ---                          │
  │ あなたの総合成績は勝率64%で...           │
  └────────────────────────────────────┘
```

#### 年別タブの追加UI
- 年選択プルダウン（対戦データがある年のみ表示）

#### 月別タブの追加UI
- 年月選択プルダウン（対戦データがある年月のみ表示）

#### テーブルのソート機能
- 各列のヘッダーをクリックで昇順・降順切り替え
- 級別成績、対戦相手別成績の両方で利用可能

#### グラフ仕様
- Chart.js を使用
- レスポンシブ対応
- 折れ線グラフ
  - 総合タブ: 横軸=年、縦軸=勝率(%)
  - 年別タブ: 横軸=月、縦軸=勝率(%)

#### AI分析
- ユーザーが自然言語で質問を入力
- 選択中の期間（総合/年別/月別）の成績データを含めてAI APIに送信
- 分析結果を画面に表示（DBには保存しない）
- セッション内でのみ保持（リロードで消える）

### 11. 対戦結果入力画面（改修）

#### 事前組み合わせの表示
```
---事前組み合わせ---

あなたの組み合わせ:
あなた vs 山田太郎 (A級初段)

[この組み合わせを使用] ボタン
（クリックすると対戦相手が自動入力される）

---または手動入力---
```

**動作**:
- ログインユーザーが `player1_id` または `player2_id` に含まれる組み合わせを `match_pairings` から取得
- 組み合わせがある場合は表示
- 「この組み合わせを使用」ボタンで対戦相手を自動入力
- 手動で別の相手を選ぶことも可能

#### 入力項目
1. **対戦日**
   - カレンダーから選択
   - デフォルト: 今日の日付
   - 練習日のみ選択可能

2. **試合番号**
   - プルダウンで選択
   - 選択肢: 1～その日の `total_matches`

3. **対戦相手**
   - Select2形式（検索可能なセレクトボックス）
   - 五十音順で表示
   - 名前のみ表示

4. **勝敗**
   - ラジオボタンまたはセレクトボックス
   - デフォルト: 勝ち

5. **枚数差**
   - 数値入力フィールド
   - バリデーション: 1～50の整数

6. **コメント**
   - テキストエリア
   - 任意入力

#### バリデーション
- 対戦日が練習日として設定されているか確認
- 枚数差が1～50の範囲内か確認
- 対戦相手が自分自身でないか確認

#### 送信後の動作
- 対戦結果を保存
- `created_by` に現在のログインユーザーを設定
- `updated_by` も同じく設定
- 保存後、日付別試合一覧画面に遷移

### 12. カレンダー画面

#### 表示内容
- 月単位のカレンダー
- 前月・次月への移動ボタン

#### カレンダーの表示状態
- **練習日**: 活性化（クリック可能）
- **練習日以外**: 非活性（グレーアウト）
- **対戦結果がある日**: 強調表示（背景色変更など）

#### 動作
- 練習日をクリック → 日付別試合一覧画面に遷移

### 13. 日付別試合一覧画面

#### 表示内容
- 選択した日付
- その日に行われた全試合のリスト
  - 試合番号
  - 対戦カード（選手1 vs 選手2）
  - 勝者
  - 枚数差

#### 機能
- 「この日の試合結果を入力」ボタン
  - クリック → 対戦結果入力画面に遷移（日付が選択済み状態）
- 各試合をクリック → 試合詳細画面に遷移

### 14. 試合詳細画面

#### 表示内容
- 対戦日
- 試合番号
- 対戦カード
- 勝者
- 枚数差
- コメント
- 作成者
- 最終更新者
- 更新日時

#### 機能
- **編集ボタン**
  - 表示条件: 自分が `player1_id` または `player2_id` の場合のみ
  - クリック → 対戦結果編集画面に遷移

- **削除ボタン**
  - 表示条件: 自分が `player1_id` または `player2_id` の場合のみ
  - クリック → 確認ダイアログ → 削除実行 → 日付別試合一覧に戻る

### 9. 参加予定入力画面

#### レイアウト
- カレンダー表示（練習日のみ活性化）
- 日付を選択すると、その日の試合番号がチェックボックスで表示
- 複数の日付・試合番号を選択可能
- 「登録」ボタンで一括登録

#### 登録済み参加予定の表示
- テーブル形式で一覧表示
- 各行に削除ボタン（訂正用）

#### 動作
- 登録 → `match_participations` テーブルに複数レコードを挿入
- 削除 → 該当レコードを物理削除

### 17. 対戦組み合わせ作成画面（管理者専用）

#### 画面構成
```
【対戦組み合わせ作成】

■ 対戦日・試合選択
対戦日: [2025-11-05 ▼] （練習日のみ）
試合番号: [第1試合目 ▼]

参加予定者: 15名
- 山田太郎 (A級初段)
- 佐藤花子 (A級二段)
- 鈴木一郎 (B級初段)
- ...

※既に組み合わせが保存されている場合
⚠ この試合の組み合わせは既に作成されています
[組み合わせを表示] [削除して再作成]

[自動マッチング実行] ボタン

---自動マッチング結果---

┌─────────────────────────────────────────┐
│ 組み合わせ1                                │
│ 選手1: [山田太郎 ▼] (A級初段)             │
│ 選手2: [佐藤花子 ▼] (A級二段)             │
│ [このペアを削除]                           │
│                                           │
│ 📊 対戦履歴（過去30日）:                  │
│   - 11/04 (1日前): 第2試合で対戦          │
│   - 10/28 (8日前): 第1試合で対戦          │
│   ※スコア: -170.0点                       │
└─────────────────────────────────────────┘

┌─────────────────────────────────────────┐
│ 組み合わせ2                                │
│ 選手1: [鈴木一郎 ▼] (B級初段)             │
│ 選手2: [田中美咲 ▼] (B級三段)             │
│ [このペアを削除]                           │
│                                           │
│ 📊 対戦履歴（過去30日）:                  │
│   - 初対戦                                │
│   ※スコア: 0点                            │
└─────────────────────────────────────────┘

...

待機者: 中村太一 (D級初段)

---手動調整---

未割り当て選手:
- 中村太一 (D級初段)
- （削除された選手）

[+ 新しい組み合わせを追加] ボタン

新しいペアを追加:
選手1: [選択してください ▼]
選手2: [選択してください ▼]
[追加]

---確定---

[確定して保存] ボタン

[キャンセル] ボタン
```

#### 自動マッチングアルゴリズム

**目的**: 対戦履歴を考慮し、なるべく初対戦または対戦間隔が空いているペアを優先

**手順**:

1. **データ取得（2回のクエリ）**
   ```sql
   -- クエリ1: 過去30日の対戦履歴（参加者に関連するもののみ）
   SELECT
       m.match_date,
       LEAST(m.player1_id, m.player2_id) as player_a,
       GREATEST(m.player1_id, m.player2_id) as player_b
   FROM matches m
   WHERE m.match_date >= DATE_SUB(:target_date, INTERVAL 30 DAY)
     AND m.match_date < :target_date
     AND (m.player1_id IN (:participant_ids)
          OR m.player2_id IN (:participant_ids))
   GROUP BY m.match_date, player_a, player_b
   ORDER BY m.match_date DESC;

   -- クエリ2: 同日の既存対戦（除外用）
   SELECT
       LEAST(player1_id, player2_id) as player_a,
       GREATEST(player1_id, player2_id) as player_b
   FROM matches
   WHERE match_date = :target_date
     AND match_number < :current_match_number;
   ```

2. **メモリ内でペアごとの対戦履歴マップを構築**
   - `Map<PairKey, Set<LocalDate>>` 形式で保持
   - PairKey: (player_id_small, player_id_large) のペア

3. **スコア計算**
   - 各ペア(i, j)に対して:
     - 同日の既存対戦に含まれる場合 → **除外**
     - 過去30日の対戦履歴から減点を計算

   **減点計算式**:
   ```
   各対戦日ごとに（練習日単位でカウント）:
   減点 = -100 × (30 - 経過日数) / 30

   例:
   - 1日前: -96.7点
   - 7日前: -76.7点
   - 15日前: -50.0点
   - 30日前: 0点
   - 31日以上前: 対象外
   ```

   **総合スコア** = 全減点の合計

4. **貪欲法でペアリング**
   - スコアの高い（減点が少ない）順にソート
   - スコアが最も高いペアから順に選択
   - 選択した選手は「割り当て済み」としてマーク
   - 全員割り当てまで繰り返し

**パフォーマンス**:
- 参加者20名の場合: 190ペアの組み合わせ
- DBクエリ: 2回のみ
- 推定応答時間: 50～100ミリ秒

#### 手動調整機能

**セレクトボックスで選手入れ替え**:
- 各組み合わせの選手をセレクトボックスで変更可能
- 選択肢には未割り当て選手 + 他の組み合わせの選手が表示
- 選手を変更すると元の位置から移動

**削除機能**:
- 「このペアを削除」ボタンで組み合わせを削除
- 削除された選手は「未割り当て選手」に移動

**追加機能**:
- 未割り当て選手から2人選んで新規ペアを作成

**既存組み合わせの処理**:
- 既に組み合わせが保存されている場合は警告表示
- 「削除して再作成」ボタンで既存データを削除してから新規作成

#### 保存処理
- 確定ボタンで `match_pairings` テーブルに一括保存
- トランザクション管理で整合性を保証

---

## 補足事項

### セキュリティ
- パスワードは BCrypt でハッシュ化
- CSRF対策（Spring Security のデフォルト機能を使用）
- XSS対策（Thymeleaf の自動エスケープ機能）

### レスポンシブデザイン
- Bootstrap を使用
- スマホでの使用を想定した UI 設計

### データ整合性
- 外部キー制約による参照整合性の保証
- トランザクション管理
- 楽観的ロックまたは悲観的ロック（必要に応じて）

### パフォーマンス
- **応答時間目標**: 3秒以内（基準であり、超過してもエラーにはしない）
- 個人成績の集計はサービスレイヤーで動的に計算
- 対戦組み合わせ自動生成は最適化済み（2回のDBクエリのみ）
- 必要なインデックスはデータベース設計セクションに記載
- 将来的にパフォーマンス問題が発生した場合は、キャッシュの導入を検討

### ログ管理
- アプリケーションログを保存（SLF4J + Logback）
- 保持期間: 30日程度（容量に応じて調整）
- ログレベル: 開発環境はDEBUG、本番環境はINFO
- 監視機能は実装しない

### データ保持・バックアップ
- 対戦データ: 永久保持
- 想定データ量: 週3回 × 4試合 × 20人 = 年間約12,000レコード
- バックアップ: 初期段階では考慮しない（必要に応じて後付け）

### その他の非機能要件
- **タイムゾーン**: 日本時間（JST）のみ対応
- **多言語対応**: なし（日本語のみ）
- **アクセシビリティ**: 考慮しない
- **データエクスポート**: 実装しない（必要になれば後付け）

---

## 今後の拡張案

- グラフの種類を増やす（棒グラフ、円グラフなど）
- エクスポート機能（CSV、PDFなど）
- 通知機能（練習日のリマインダーなど）
- モバイルアプリ化（PWA）
- リアルタイム更新（WebSocket）
- マッチングアルゴリズムの改善（機械学習による最適化）
- 対戦組み合わせの事前計算・キャッシュ

---

## 段階的リリース計画

### Phase 1: MVP（Minimum Viable Product）
**目標**: 基本的な対戦記録と成績表示

**対象機能**:
- 認証機能（ログイン・ログアウト）
  - ロールベース権限管理（SUPER_ADMIN、ADMIN、PLAYER）
- 選手管理（SUPER_ADMINのみ）
  - 選手の新規登録・編集・削除（論理削除）
  - ロール変更
- 練習日管理（SUPER_ADMINとADMIN）
  - 練習日の作成・編集・削除
- 対戦結果入力（全ユーザー）
  - 手動での対戦結果入力
  - 自分が関わった試合の編集・削除
- 個人成績表示（全ユーザー）
  - 総合タブのみ（年別・月別タブはPhase 2）
  - 基本成績（総対戦数、勝率、平均枚数差）
  - グラフなし
- エラー画面
  - エラーメッセージ、HTTPステータスコード表示

**データベース**:
- players（`role`、`deleted_at`追加）
- player_profiles
- matches
- practice_sessions

**除外機能**:
- AI分析
- 対戦組み合わせ自動生成
- 参加予定管理
- 年別・月別タブ
- グラフ表示
- 級別成績・対戦相手別成績テーブル

**テスト**:
- 単体テスト（サービス層のビジネスロジック）
- 結合テスト（データベース連携）
- 最低限のE2Eテスト

---

### Phase 2: 成績分析機能強化
**目標**: 成績の詳細分析とビジュアライゼーション

**追加機能**:
- 個人成績の年別・月別タブ
  - 年選択プルダウン
  - 月選択プルダウン
- 勝率推移グラフ（Chart.js）
  - 総合タブ: 年別推移
  - 年別タブ: 月別推移
- 級別成績テーブル（ソート可能）
- 対戦相手別成績テーブル（ソート可能）
- 参加予定管理
  - カレンダー形式での日付選択
  - 試合番号のチェックボックス選択
  - 登録済み予定の表示・削除

**テスト**:
- グラフ表示の動作確認
- テーブルソート機能のテスト
- 参加予定管理の結合テスト

---

### Phase 3: 自動化機能
**目標**: 管理業務の効率化

**追加機能**:
- 対戦組み合わせ自動生成（SUPER_ADMINとADMIN）
  - 待機者の手動/自動設定
  - 自動マッチングアルゴリズム
  - 手動調整機能（セレクトボックスで入れ替え・削除・追加）
  - 対戦履歴の表示
- 事前組み合わせの表示（対戦結果入力時）
  - 推奨ペアの表示
  - 手動での別の相手選択も可能

**データベース**:
- match_pairings
- match_participations（Phase 2で追加済み）

**テスト**:
- マッチングアルゴリズムの単体テスト
- 組み合わせ保存・削除の結合テスト
- パフォーマンステスト（20名規模）

---

### Phase 4: AI分析機能
**目標**: 高度な成績分析

**追加機能**:
- Anthropic Claude API連携
- 自然言語での質問機能
  - 期間別データを含めて分析
  - 結果はセッション内でのみ保持
- レート制限の実装
  - アプリ全体で月100回まで
  - 超過時のエラーメッセージ表示
  - 毎月1日0時にカウンターリセット

**データベース**:
- ai_usage_logs

**テスト**:
- API連携のモックテスト
- レート制限の動作確認
- エラーハンドリングのテスト

**注意事項**:
- APIキーの安全な管理（環境変数で設定）
- コスト監視（月$3程度を目安）

---

## テーブル数・画面数まとめ

### テーブル数: 7テーブル
1. players（選手マスタ）
2. player_profiles（選手情報履歴）
3. matches（対戦結果）
4. practice_sessions（練習日情報）
5. match_participations（選手の参加予定）
6. match_pairings（対戦組み合わせ）
7. ai_usage_logs（AI分析使用記録）

**注**: `super_admins`テーブルは廃止。ロール管理を`players`テーブルに統合。

### 画面数: 16画面
- 全ユーザー共通: 16画面（認証統一により削減）

---

**文書作成日**: 2025-11-05
**最終更新日**: 2025-11-06
**レビュー実施日**: 2025-11-06
**作成者**: Claude (AI Assistant)
**承認**: ユーザー確認完了
**変更履歴**: DESIGN_REVIEW_DECISIONS.md参照
